{% extends "base.html" %}
{% block title %}Check Threats - CyberVantage{% endblock %}

{% block extra_styles %}
.threat-checker {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    margin: 1rem 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.scan-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.scan-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
}

.scan-card:hover {
    border-color: #3498db;
    background: #e3f2fd;
    transform: translateY(-2px);
}

.scan-card.active {
    border-color: #3498db;
    background: #e3f2fd;
}

.scan-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    display: block;
}

.scan-form {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 2rem;
    margin-top: 2rem;
}

.file-drop-zone {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    margin: 1rem 0;
    transition: border-color 0.3s;
}

.file-drop-zone:hover, .file-drop-zone.dragover {
    border-color: #3498db;
    background-color: #f0f8ff;
}

.results-container {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    margin-top: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.threat-status {
    padding: 1rem;
    border-radius: 6px;
    margin: 1rem 0;
    font-weight: 500;
}

.threat-clean { background-color: #d4edda; color: #155724; }
.threat-suspicious { background-color: #fff3cd; color: #856404; }
.threat-malicious { background-color: #f8d7da; color: #721c24; }

.intel-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.intel-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1.5rem;
}

.intel-header {
    display: flex;
    align-items: center;
    justify-content: between;
    margin-bottom: 1rem;
}

.severity-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
    text-transform: uppercase;
}

.severity-high { background-color: #dc3545; color: white; }
.severity-medium { background-color: #fd7e14; color: white; }
.severity-low { background-color: #28a745; color: white; }
{% endblock %}

{% block content %}
<h1>üîç Threat Detection Center</h1>
<p>Analyze URLs, files, and gather threat intelligence using VirusTotal's powerful scanning engine.</p>

<div class="threat-checker">
    <h2>Choose Scan Type</h2>
    
    <div class="scan-options">
        <div class="scan-card" onclick="selectScanType('url')">
            <span class="scan-icon">üåê</span>
            <h3>URL Scanner</h3>
            <p>Scan websites and URLs for malicious content, phishing, and malware.</p>
        </div>
        
        <div class="scan-card" onclick="selectScanType('file')">
            <span class="scan-icon">üìÅ</span>
            <h3>File Scanner</h3>
            <p>Upload and analyze files for viruses, trojans, and other malicious content.</p>
        </div>
        
        <div class="scan-card" onclick="selectScanType('intel')">
            <span class="scan-icon">üìä</span>
            <h3>Threat Intelligence</h3>
            <p>Get the latest threat intelligence reports and security information.</p>
        </div>
    </div>
</div>

<!-- URL Scanner Form -->
<div id="url-scanner" class="scan-form" style="display: none;">
    <h3>üåê URL Threat Scanner</h3>
    <p>Enter a URL to check for phishing, malware, and other security threats.</p>
    
    <form id="url-scan-form">
        <div class="form-group" style="margin-bottom: 1rem;">
            <label for="url-input">URL to scan:</label>
            <input type="url" id="url-input" class="form-control" placeholder="https://example.com" required
                   style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem;">
        </div>
        
        <button type="submit" class="btn primary">Scan URL</button>
        <button type="button" class="btn secondary" onclick="clearResults()" style="margin-left: 1rem;">Clear</button>
    </form>
</div>

<!-- File Scanner Form -->
<div id="file-scanner" class="scan-form" style="display: none;">
    <h3>üìÅ File Threat Scanner</h3>
    <p>Upload a file to scan for viruses, malware, and other security threats.</p>
    
    <form id="file-scan-form" enctype="multipart/form-data">
        <div class="file-drop-zone" id="file-drop-zone">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
            <p>Drag and drop a file here, or click to select</p>
            <input type="file" id="file-input" accept="*/*" style="display: none;">
            <button type="button" onclick="document.getElementById('file-input').click()" class="btn secondary">
                Choose File
            </button>
        </div>
        
        <div id="file-info" style="display: none; margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
            <p><strong>Selected file:</strong> <span id="file-name"></span></p>
            <p><strong>Size:</strong> <span id="file-size"></span></p>
        </div>
        
        <button type="submit" class="btn primary" disabled>Scan File</button>
        <button type="button" class="btn secondary" onclick="clearFile()" style="margin-left: 1rem;">Clear</button>
    </form>
</div>

<!-- Threat Intelligence -->
<div id="threat-intel" class="scan-form" style="display: none;">
    <h3>üìä Latest Threat Intelligence</h3>
    <p>Stay informed about the latest cybersecurity threats and attack patterns.</p>
    
    <div style="text-align: center; margin: 2rem 0;">
        <button id="load-intel" class="btn primary">Load Latest Threats</button>
    </div>
    
    <div id="intel-results"></div>
</div>

<!-- Results Container -->
<div id="scan-results" class="results-container" style="display: none;">
    <h3>Scan Results</h3>
    <div id="results-content">
        <div style="text-align: center; padding: 2rem;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>Analyzing... Please wait.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentScanType = null;
    
    // Initialize file upload handling
    const fileInput = document.getElementById('file-input');
    const fileDropZone = document.getElementById('file-drop-zone');
    const fileInfo = document.getElementById('file-info');
    
    // File drag and drop
    fileDropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        fileDropZone.classList.add('dragover');
    });
    
    fileDropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        fileDropZone.classList.remove('dragover');
    });
    
    fileDropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        fileDropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });
    
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleFileSelection(this.files[0]);
        }
    });
    
    function handleFileSelection(file) {
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        fileInfo.style.display = 'block';
        document.querySelector('#file-scan-form button[type="submit"]').disabled = false;
    }
    
    // Form submissions
    document.getElementById('url-scan-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const url = document.getElementById('url-input').value;
        scanURL(url);
    });
    
    document.getElementById('file-scan-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const file = fileInput.files[0];
        if (file) {
            scanFile(file);
        }
    });
    
    document.getElementById('load-intel').addEventListener('click', function() {
        loadThreatIntel();
    });
    
    function scanURL(url) {
        showResults();
        
        fetch('/api/threats/url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url: url })
        })
        .then(response => response.json())
        .then(data => {
            displayURLResults(data, url);
        })
        .catch(error => {
            displayError('Failed to scan URL: ' + error.message);
        });
    }
    
    function scanFile(file) {
        showResults();
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/api/threats/file', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            displayFileResults(data, file.name);
        })
        .catch(error => {
            displayError('Failed to scan file: ' + error.message);
        });
    }
    
    function loadThreatIntel() {
        const intelResults = document.getElementById('intel-results');
        intelResults.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i><p>Loading threat intelligence...</p></div>';
        
        fetch('/api/threats/intel')
        .then(response => response.json())
        .then(data => {
            displayThreatIntel(data.intel);
        })
        .catch(error => {
            intelResults.innerHTML = '<div class="alert alert-danger">Failed to load threat intelligence: ' + error.message + '</div>';
        });
    }
    
    function displayURLResults(data, url) {
        let resultsHTML = '';
        
        if (data.error) {
            resultsHTML = `<div class="threat-status threat-malicious">‚ùå Error: ${data.error}</div>`;
        } else if (data.scan_id) {
            resultsHTML = `
                <div class="threat-status threat-suspicious">
                    ‚è≥ ${data.message}
                    <p style="margin-top: 0.5rem;">Scan ID: ${data.scan_id}</p>
                    <p>Results will be available shortly. You can check back or use the scan ID for detailed results.</p>
                </div>
                <div style="margin-top: 1rem;">
                    <h4>Scanned URL:</h4>
                    <p style="word-break: break-all; background: #f8f9fa; padding: 1rem; border-radius: 4px;">${url}</p>
                </div>
            `;
        } else {
            // Handle completed scan results
            const detections = data.positives || 0;
            const total = data.total || 0;
            const status = detections === 0 ? 'clean' : detections > 5 ? 'malicious' : 'suspicious';
            const statusText = detections === 0 ? '‚úÖ Clean' : detections > 5 ? 'üö® Malicious' : '‚ö†Ô∏è Suspicious';
            
            resultsHTML = `
                <div class="threat-status threat-${status}">
                    ${statusText} - ${detections}/${total} security vendors flagged this URL
                </div>
                <div style="margin-top: 1rem;">
                    <h4>Scanned URL:</h4>
                    <p style="word-break: break-all; background: #f8f9fa; padding: 1rem; border-radius: 4px;">${url}</p>
                    ${data.permalink ? `<p><a href="${data.permalink}" target="_blank">View detailed report on VirusTotal</a></p>` : ''}
                </div>
            `;
        }
        
        document.getElementById('results-content').innerHTML = resultsHTML;
    }
    
    function displayFileResults(data, filename) {
        let resultsHTML = '';
        
        if (data.error) {
            resultsHTML = `<div class="threat-status threat-malicious">‚ùå Error: ${data.error}</div>`;
        } else if (data.scan_id) {
            resultsHTML = `
                <div class="threat-status threat-suspicious">
                    ‚è≥ ${data.message}
                    <p style="margin-top: 0.5rem;">Scan ID: ${data.scan_id}</p>
                    <p>File analysis in progress. Results will be available shortly.</p>
                </div>
                <div style="margin-top: 1rem;">
                    <h4>Scanned File:</h4>
                    <p style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">${filename}</p>
                </div>
            `;
        } else {
            // Handle completed scan results
            const detections = data.positives || 0;
            const total = data.total || 0;
            const status = detections === 0 ? 'clean' : detections > 5 ? 'malicious' : 'suspicious';
            const statusText = detections === 0 ? '‚úÖ Clean' : detections > 5 ? 'üö® Malicious' : '‚ö†Ô∏è Suspicious';
            
            resultsHTML = `
                <div class="threat-status threat-${status}">
                    ${statusText} - ${detections}/${total} security vendors detected threats
                </div>
                <div style="margin-top: 1rem;">
                    <h4>Scanned File:</h4>
                    <p style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">${filename}</p>
                    ${data.permalink ? `<p><a href="${data.permalink}" target="_blank">View detailed report on VirusTotal</a></p>` : ''}
                </div>
            `;
        }
        
        document.getElementById('results-content').innerHTML = resultsHTML;
    }
    
    function displayThreatIntel(intelData) {
        const intelResults = document.getElementById('intel-results');
        
        if (!intelData || intelData.length === 0) {
            intelResults.innerHTML = '<p>No threat intelligence data available at this time.</p>';
            return;
        }
        
        let html = '<div class="intel-grid">';
        
        intelData.forEach(threat => {
            html += `
                <div class="intel-card">
                    <div class="intel-header">
                        <h4 style="margin: 0; flex: 1;">${threat.name || threat.type}</h4>
                        <span class="severity-badge severity-${threat.severity || 'medium'}">${threat.severity || 'medium'}</span>
                    </div>
                    <p><strong>Type:</strong> ${threat.type || 'Unknown'}</p>
                    <p><strong>Reported:</strong> ${threat.date_reported || 'Recent'}</p>
                    <p>${threat.description || 'No description available.'}</p>
                </div>
            `;
        });
        
        html += '</div>';
        intelResults.innerHTML = html;
    }
    
    function displayError(message) {
        document.getElementById('results-content').innerHTML = `
            <div class="threat-status threat-malicious">‚ùå ${message}</div>
        `;
    }
    
    function showResults() {
        document.getElementById('scan-results').style.display = 'block';
        document.getElementById('results-content').innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                <p>Analyzing... Please wait.</p>
            </div>
        `;
    }
    
    function clearResults() {
        document.getElementById('scan-results').style.display = 'none';
        document.getElementById('url-input').value = '';
    }
    
    function clearFile() {
        fileInput.value = '';
        fileInfo.style.display = 'none';
        document.querySelector('#file-scan-form button[type="submit"]').disabled = true;
        document.getElementById('scan-results').style.display = 'none';
    }
    
    // Global functions for scan type selection
    window.selectScanType = function(type) {
        // Hide all scan forms
        document.getElementById('url-scanner').style.display = 'none';
        document.getElementById('file-scanner').style.display = 'none';
        document.getElementById('threat-intel').style.display = 'none';
        
        // Remove active class from all cards
        document.querySelectorAll('.scan-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Show selected form and activate card
        document.getElementById(type + '-scanner').style.display = 'block';
        if (type === 'intel') {
            document.getElementById('threat-intel').style.display = 'block';
        }
        
        event.target.closest('.scan-card').classList.add('active');
        currentScanType = type;
        
        // Clear previous results
        document.getElementById('scan-results').style.display = 'none';
    };
});
</script>
{% endblock %}