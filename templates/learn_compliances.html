{% extends "base.html" %}
{% block title %}Learn Compliances - CyberVantage{% endblock %}

{% block extra_styles %}
<style>
.learning-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.module-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    backdrop-filter: blur(var(--glass-blur));
    overflow: hidden;
}

.module-header {
    background: linear-gradient(135deg, rgba(112, 0, 255, 0.4), rgba(0, 242, 255, 0.2));
    color: white;
    padding: 1rem 1.5rem;
    font-size: 1.1rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--glass-border);
}

.module-content {
    padding: 1.5rem;
}

.slides-container {
    margin-bottom: 1.5rem;
}

.quiz-container {
    margin-top: 1.5rem;
    border-top: 1px solid var(--glass-border);
    padding-top: 1.5rem;
    display: none;
}

.quiz-container.available {
    display: block;
}

.progress-bar {
    height: 10px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 5px;
    margin-bottom: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary));
    border-radius: 5px;
    width: 0%;
    transition: width 0.5s;
}

.slide {
    display: none;
}

.slide.active {
    display: block;
}

.slide h3 {
    color: var(--accent-color);
    margin-bottom: 0.75rem;
}

.slide p, .slide li {
    color: rgba(255, 255, 255, 0.8);
}

.slide-controls {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
}

.slide-btn {
    background: var(--accent-color);
    color: #000;
    padding: 0.5rem 1.2rem;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.slide-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
}

.slide-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.3);
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
}

.slide-indicators {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
}

.slide-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    cursor: pointer;
    transition: all 0.3s;
}

.slide-indicator.active {
    background: var(--accent-color);
    box-shadow: 0 0 8px rgba(0, 242, 255, 0.5);
}

.quiz-question {
    margin-bottom: 1.5rem;
}

.quiz-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.quiz-option {
    padding: 12px 15px;
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.03);
}

.quiz-option:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.2);
}

.quiz-option.selected {
    border-color: var(--accent-color);
    background: rgba(0, 242, 255, 0.08);
}

.quiz-option.correct {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.1);
    color: #5ddc7e;
}

.quiz-option.incorrect {
    border-color: #dc3545;
    background: rgba(220, 53, 69, 0.1);
    color: #ff6b6b;
}

.quiz-feedback {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    display: none;
}

.feedback-correct {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    color: #5ddc7e;
}

.feedback-incorrect {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    color: #ff6b6b;
}

.module-btn {
    background: var(--accent-color);
    color: #000;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.module-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
}

.quiz-controls {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.reset-btn {
    background: rgba(220, 53, 69, 0.3) !important;
    color: #ff6b6b !important;
    border: 1px solid rgba(220, 53, 69, 0.5) !important;
}

.reset-btn:hover {
    background: rgba(220, 53, 69, 0.5) !important;
}

.deselect-btn {
    background: rgba(255, 193, 7, 0.25);
    color: #ffd93d;
    padding: 0.25rem 0.5rem;
    border: 1px solid rgba(255, 193, 7, 0.4);
    border-radius: 50px;
    cursor: pointer;
    font-size: 0.8rem;
    margin-top: 0.5rem;
    transition: all 0.3s;
}

.deselect-btn:hover {
    background: rgba(255, 193, 7, 0.4);
}

.example-box {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.compliance-principles {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin: 1rem 0;
}

.principle {
    background: rgba(255, 255, 255, 0.03);
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--accent-color);
}

.module-card.locked .module-content {
    opacity: 0.4;
    pointer-events: none;
}

.module-status {
    font-weight: bold;
}

.module-status.unlocked {
    color: #5ddc7e;
}

.module-status.locked {
    color: #ff6b6b;
}

@media (max-width: 768px) {
    .module-header {
        flex-direction: column;
        gap: 0.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="{{ url_for('analysis.learn') }}" style="color: var(--accent-color); text-decoration: none;"><i class="fas fa-arrow-left"></i> Back to Learn</a>
</div>
<h1 style="text-align: center;">Learn About Compliances</h1>
<p style="text-align: center; color: rgba(255,255,255,0.6); margin-bottom: 2rem;">Understand key cybersecurity frameworks and standards</p>

<div class="learning-content">
    <!-- Module 1: NIST -->
    <div class="module-card">
        <div class="module-header">
            <div>Module 1: NIST Cybersecurity Framework</div>
            <div>Progress: <span id="module1-progress">0%</span></div>
        </div>
        <div class="module-content">
            <div class="progress-bar">
                <div class="progress-fill" id="module1-progress-bar" style="width: 0%"></div>
            </div>

            <div class="slides-container" id="module1-slides">
                <div class="slide active" id="module1-slide1">
                    <h3>What is the NIST Framework?</h3>
                    <p>The NIST Cybersecurity Framework (CSF) is a set of guidelines developed by the National Institute of Standards and Technology to help organisations manage and reduce cybersecurity risk.</p>
                    <div class="example-box">
                        <h4>Key Facts:</h4>
                        <ul>
                            <li>Originally published in 2014, updated to NIST CSF 2.0 in 2024</li>
                            <li>Voluntary framework widely adopted globally</li>
                            <li>Designed for all organisation sizes and sectors</li>
                            <li>Provides a common language for cybersecurity risk management</li>
                        </ul>
                    </div>
                </div>

                <div class="slide" id="module1-slide2">
                    <h3>The Six Core Functions</h3>
                    <div class="compliance-principles">
                        <div class="principle">
                            <h4>üîç Govern</h4>
                            <p>Establish and monitor cybersecurity risk management strategy, expectations, and policy.</p>
                        </div>
                        <div class="principle">
                            <h4>üéØ Identify</h4>
                            <p>Understand the organisation's assets, risks, and current cybersecurity posture.</p>
                        </div>
                        <div class="principle">
                            <h4>üõ°Ô∏è Protect</h4>
                            <p>Implement safeguards to limit or contain the impact of a cybersecurity event.</p>
                        </div>
                        <div class="principle">
                            <h4>üîî Detect</h4>
                            <p>Develop and implement activities to identify the occurrence of a cybersecurity event.</p>
                        </div>
                        <div class="principle">
                            <h4>‚ö° Respond</h4>
                            <p>Take action regarding a detected cybersecurity incident.</p>
                        </div>
                        <div class="principle">
                            <h4>üîÑ Recover</h4>
                            <p>Maintain plans for resilience and restore any capabilities impaired by incidents.</p>
                        </div>
                    </div>
                </div>

                <div class="slide" id="module1-slide3">
                    <h3>Implementation Tiers</h3>
                    <p>NIST defines four tiers describing how well an organisation manages cybersecurity risk:</p>
                    <ul>
                        <li><strong>Tier 1 ‚Äì Partial:</strong> Ad hoc, reactive risk management practices</li>
                        <li><strong>Tier 2 ‚Äì Risk Informed:</strong> Practices approved by management but not fully integrated</li>
                        <li><strong>Tier 3 ‚Äì Repeatable:</strong> Formally established, consistently applied policies</li>
                        <li><strong>Tier 4 ‚Äì Adaptive:</strong> Organisation adapts practices based on lessons learned and predictive indicators</li>
                    </ul>
                </div>

                <div class="slide-controls">
                    <button id="module1-prev-slide" class="slide-btn" disabled>Previous</button>
                    <button id="module1-next-slide" class="slide-btn">Next</button>
                </div>

                <div class="slide-indicators">
                    <div class="slide-indicator active" data-slide="1"></div>
                    <div class="slide-indicator" data-slide="2"></div>
                    <div class="slide-indicator" data-slide="3"></div>
                </div>
            </div>

            <div class="quiz-container">
                <h3>Evaluate Your Knowledge</h3>
                <div class="quiz-question" data-question-id="1">
                    <p>1. <span class="question-text">Loading...</span></p>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">A</div>
                        <div class="quiz-option" data-correct="false">B</div>
                        <div class="quiz-option" data-correct="true">C</div>
                        <div class="quiz-option" data-correct="false">D</div>
                    </div>
                    <div class="quiz-feedback"></div>
                    <button class="deselect-btn" style="display: none;">Deselect Answer</button>
                </div>

                <div class="quiz-question" data-question-id="2">
                    <p>2. <span class="question-text">Loading...</span></p>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">A</div>
                        <div class="quiz-option" data-correct="false">B</div>
                        <div class="quiz-option" data-correct="true">C</div>
                        <div class="quiz-option" data-correct="false">D</div>
                    </div>
                    <div class="quiz-feedback"></div>
                    <button class="deselect-btn" style="display: none;">Deselect Answer</button>
                </div>

                <div class="quiz-controls">
                    <button id="module1-submit-quiz" class="module-btn">Submit Answers</button>
                    <button id="module1-reset-quiz" class="module-btn reset-btn">Reset Quiz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Module 2: ISO 27001 -->
    <div class="module-card" id="module2">
        <div class="module-header">
            <div>Module 2: ISO 27001</div>
            <div>Progress: <span id="module2-progress">0%</span> | Status: <span class="module-status">Locked</span></div>
        </div>
        <div class="module-content" id="module2-content">
            <div class="progress-bar">
                <div class="progress-fill" id="module2-progress-bar" style="width: 0%"></div>
            </div>

            <div class="slides-container" id="module2-slides">
                <div class="slide active" id="module2-slide1">
                    <h3>What is ISO 27001?</h3>
                    <p>ISO/IEC 27001 is an international standard for Information Security Management Systems (ISMS). It provides a systematic approach to managing sensitive company information so that it remains secure.</p>
                    <div class="example-box">
                        <h4>Key Facts:</h4>
                        <ul>
                            <li>Published by the International Organization for Standardization (ISO)</li>
                            <li>Certification-based standard (organisations can be audited and certified)</li>
                            <li>Latest version: ISO/IEC 27001:2022</li>
                            <li>Covers people, processes, and technology</li>
                        </ul>
                    </div>
                </div>

                <div class="slide" id="module2-slide2">
                    <h3>Key Principles of ISO 27001</h3>
                    <div class="compliance-principles">
                        <div class="principle">
                            <h4>üìã Risk Assessment</h4>
                            <p>Identify information security risks and determine appropriate treatments.</p>
                        </div>
                        <div class="principle">
                            <h4>üìù Documented ISMS</h4>
                            <p>Establish, implement, maintain, and continually improve an information security management system.</p>
                        </div>
                        <div class="principle">
                            <h4>üîÑ Continual Improvement</h4>
                            <p>Plan-Do-Check-Act (PDCA) cycle to ensure ongoing effectiveness of the ISMS.</p>
                        </div>
                        <div class="principle">
                            <h4>üë• Leadership Commitment</h4>
                            <p>Top management must demonstrate leadership and commitment to the ISMS.</p>
                        </div>
                    </div>
                </div>

                <div class="slide" id="module2-slide3">
                    <h3>Annex A Controls</h3>
                    <p>ISO 27001:2022 includes 93 controls organised into four themes:</p>
                    <ul>
                        <li><strong>Organisational Controls (37):</strong> Policies, roles, responsibilities, and asset management</li>
                        <li><strong>People Controls (8):</strong> Screening, awareness, training, and disciplinary processes</li>
                        <li><strong>Physical Controls (14):</strong> Security perimeters, entry controls, and equipment protection</li>
                        <li><strong>Technological Controls (34):</strong> Access management, encryption, logging, and secure development</li>
                    </ul>
                </div>

                <div class="slide-controls">
                    <button id="module2-prev-slide" class="slide-btn" disabled>Previous</button>
                    <button id="module2-next-slide" class="slide-btn">Next</button>
                </div>

                <div class="slide-indicators">
                    <div class="slide-indicator active" data-slide="1"></div>
                    <div class="slide-indicator" data-slide="2"></div>
                    <div class="slide-indicator" data-slide="3"></div>
                </div>
            </div>

            <div class="quiz-container">
                <h3>Evaluate Your Knowledge</h3>
                <div class="quiz-question" data-question-id="1">
                    <p>1. <span class="question-text">Loading...</span></p>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">A</div>
                        <div class="quiz-option" data-correct="false">B</div>
                        <div class="quiz-option" data-correct="true">C</div>
                        <div class="quiz-option" data-correct="false">D</div>
                    </div>
                    <div class="quiz-feedback"></div>
                    <button class="deselect-btn" style="display: none;">Deselect Answer</button>
                </div>

                <div class="quiz-question" data-question-id="2">
                    <p>2. <span class="question-text">Loading...</span></p>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">A</div>
                        <div class="quiz-option" data-correct="false">B</div>
                        <div class="quiz-option" data-correct="true">C</div>
                        <div class="quiz-option" data-correct="false">D</div>
                    </div>
                    <div class="quiz-feedback"></div>
                    <button class="deselect-btn" style="display: none;">Deselect Answer</button>
                </div>

                <div class="quiz-controls">
                    <button id="module2-submit-quiz" class="module-btn">Submit Answers</button>
                    <button id="module2-reset-quiz" class="module-btn reset-btn">Reset Quiz</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Module 3: Australian Essential Eight -->
    <div class="module-card" id="module3">
        <div class="module-header">
            <div>Module 3: Australian Essential Eight</div>
            <div>Progress: <span id="module3-progress">0%</span> | Status: <span class="module-status">Locked</span></div>
        </div>
        <div class="module-content" id="module3-content">
            <div class="progress-bar">
                <div class="progress-fill" id="module3-progress-bar" style="width: 0%"></div>
            </div>

            <div class="slides-container" id="module3-slides">
                <div class="slide active" id="module3-slide1">
                    <h3>What is the Essential Eight?</h3>
                    <p>The Essential Eight is a set of baseline mitigation strategies recommended by the Australian Cyber Security Centre (ACSC) to protect organisations against various cyber threats.</p>
                    <div class="example-box">
                        <h4>Key Facts:</h4>
                        <ul>
                            <li>Developed by the Australian Signals Directorate (ASD)</li>
                            <li>Mandatory for Australian federal government entities</li>
                            <li>Widely recommended for all Australian organisations</li>
                            <li>Maturity model with four levels: Level Zero through Level Three</li>
                        </ul>
                    </div>
                </div>

                <div class="slide" id="module3-slide2">
                    <h3>The Eight Strategies</h3>
                    <div class="compliance-principles">
                        <div class="principle">
                            <h4>1. Application Control</h4>
                            <p>Prevent execution of unapproved or malicious programs.</p>
                        </div>
                        <div class="principle">
                            <h4>2. Patch Applications</h4>
                            <p>Patch security vulnerabilities in applications within 48 hours when exploits exist.</p>
                        </div>
                        <div class="principle">
                            <h4>3. Configure Microsoft Office Macro Settings</h4>
                            <p>Block macros from the internet and only allow vetted macros.</p>
                        </div>
                        <div class="principle">
                            <h4>4. User Application Hardening</h4>
                            <p>Configure web browsers to block ads, Java, and Flash; disable unneeded features.</p>
                        </div>
                    </div>
                </div>

                <div class="slide" id="module3-slide3">
                    <h3>The Eight Strategies (continued)</h3>
                    <div class="compliance-principles">
                        <div class="principle">
                            <h4>5. Restrict Administrative Privileges</h4>
                            <p>Limit admin access to only those who need it. Regularly revalidate the need.</p>
                        </div>
                        <div class="principle">
                            <h4>6. Patch Operating Systems</h4>
                            <p>Patch OS security vulnerabilities within 48 hours when exploits exist.</p>
                        </div>
                        <div class="principle">
                            <h4>7. Multi-Factor Authentication (MFA)</h4>
                            <p>Require MFA for all users when accessing important data and systems.</p>
                        </div>
                        <div class="principle">
                            <h4>8. Regular Backups</h4>
                            <p>Perform regular backups of important data, software, and configuration settings.</p>
                        </div>
                    </div>
                </div>

                <div class="slide" id="module3-slide4">
                    <h3>Maturity Levels</h3>
                    <p>The Essential Eight Maturity Model defines four maturity levels:</p>
                    <ul>
                        <li><strong>Maturity Level Zero:</strong> Weaknesses exist that can be exploited</li>
                        <li><strong>Maturity Level One:</strong> Partly aligned ‚Äì mitigates opportunistic adversaries</li>
                        <li><strong>Maturity Level Two:</strong> Mostly aligned ‚Äì mitigates more capable adversaries</li>
                        <li><strong>Maturity Level Three:</strong> Fully aligned ‚Äì mitigates sophisticated adversaries</li>
                    </ul>
                    <div class="example-box">
                        <p><strong>Goal:</strong> All organisations should aim to achieve at least Maturity Level One for all eight strategies, then progressively increase.</p>
                    </div>
                </div>

                <div class="slide-controls">
                    <button id="module3-prev-slide" class="slide-btn" disabled>Previous</button>
                    <button id="module3-next-slide" class="slide-btn">Next</button>
                </div>

                <div class="slide-indicators">
                    <div class="slide-indicator active" data-slide="1"></div>
                    <div class="slide-indicator" data-slide="2"></div>
                    <div class="slide-indicator" data-slide="3"></div>
                    <div class="slide-indicator" data-slide="4"></div>
                </div>
            </div>

            <div class="quiz-container">
                <h3>Evaluate Your Knowledge</h3>
                <div class="quiz-question" data-question-id="1">
                    <p>1. <span class="question-text">Loading...</span></p>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">A</div>
                        <div class="quiz-option" data-correct="false">B</div>
                        <div class="quiz-option" data-correct="true">C</div>
                        <div class="quiz-option" data-correct="false">D</div>
                    </div>
                    <div class="quiz-feedback"></div>
                    <button class="deselect-btn" style="display: none;">Deselect Answer</button>
                </div>

                <div class="quiz-question" data-question-id="2">
                    <p>2. <span class="question-text">Loading...</span></p>
                    <div class="quiz-options">
                        <div class="quiz-option" data-correct="false">A</div>
                        <div class="quiz-option" data-correct="false">B</div>
                        <div class="quiz-option" data-correct="true">C</div>
                        <div class="quiz-option" data-correct="false">D</div>
                    </div>
                    <div class="quiz-feedback"></div>
                    <button class="deselect-btn" style="display: none;">Deselect Answer</button>
                </div>

                <div class="quiz-controls">
                    <button id="module3-submit-quiz" class="module-btn">Submit Answers</button>
                    <button id="module3-reset-quiz" class="module-btn reset-btn">Reset Quiz</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modules = {
            1: { currentSlide: 1, totalSlides: 3, completed: false, prefix: 'module1-', nextModule: 2 },
            2: { currentSlide: 1, totalSlides: 3, completed: false, prefix: 'module2-', nextModule: 3 },
            3: { currentSlide: 1, totalSlides: 4, completed: false, prefix: 'module3-', nextModule: null }
        };

        const questionBanks = {
            1: [
                { question: "What does the NIST Cybersecurity Framework primarily help organisations do?", options: ["Build websites", "Manage and reduce cybersecurity risk", "Create software applications", "Design computer hardware"], correct: 1 },
                { question: "Which of these is a core function in the NIST CSF 2.0?", options: ["Compile", "Govern", "Program", "Install"], correct: 1 },
                { question: "How many implementation tiers does the NIST framework define?", options: ["Two", "Three", "Four", "Five"], correct: 2 },
                { question: "The highest NIST implementation tier is called:", options: ["Complete", "Adaptive", "Maximum", "Integrated"], correct: 1 }
            ],
            2: [
                { question: "What does ISO 27001 primarily address?", options: ["Financial accounting", "Information Security Management Systems", "Environmental standards", "Quality manufacturing"], correct: 1 },
                { question: "ISO 27001 uses which improvement cycle?", options: ["Agile sprints", "Waterfall methodology", "Plan-Do-Check-Act (PDCA)", "Trial and error"], correct: 2 },
                { question: "How many controls are in ISO 27001:2022 Annex A?", options: ["55", "72", "93", "114"], correct: 2 },
                { question: "ISO 27001 certification requires:", options: ["Only filling out a form", "An independent audit by an accredited body", "Buying a license", "Government approval only"], correct: 1 }
            ],
            3: [
                { question: "Who developed the Essential Eight framework?", options: ["Microsoft", "Australian Signals Directorate (ASD)", "Google", "United Nations"], correct: 1 },
                { question: "Which of these is one of the Essential Eight strategies?", options: ["Social media monitoring", "Multi-Factor Authentication", "Cryptocurrency mining", "Email marketing"], correct: 1 },
                { question: "How many maturity levels does the Essential Eight define?", options: ["Two", "Three", "Four", "Five"], correct: 2 },
                { question: "The Essential Eight is mandatory for:", options: ["All global companies", "Australian federal government entities", "Social media platforms only", "Private individuals"], correct: 1 }
            ]
        };

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function populateQuiz(moduleNum) {
            const moduleCard = document.getElementById(`module${moduleNum}`) || document.querySelector('.module-card');
            if (!moduleCard) return;
            const questions = shuffleArray(questionBanks[moduleNum]).slice(0, 2);
            const quizQuestions = moduleCard.querySelectorAll('.quiz-question');
            questions.forEach((questionData, index) => {
                if (quizQuestions[index]) {
                    const questionElement = quizQuestions[index];
                    const questionText = questionElement.querySelector('.question-text');
                    const options = questionElement.querySelectorAll('.quiz-option');
                    if (questionText) questionText.textContent = questionData.question;
                    options.forEach((option, optionIndex) => {
                        option.textContent = questionData.options[optionIndex];
                        option.setAttribute('data-correct', optionIndex === questionData.correct ? 'true' : 'false');
                        option.classList.remove('selected', 'correct', 'incorrect');
                    });
                    const feedback = questionElement.querySelector('.quiz-feedback');
                    if (feedback) { feedback.style.display = 'none'; feedback.textContent = ''; }
                    const deselectBtn = questionElement.querySelector('.deselect-btn');
                    if (deselectBtn) deselectBtn.style.display = 'none';
                }
            });
        }

        function initializeModules() {
            for (let i = 1; i <= 3; i++) {
                if (localStorage.getItem(`compliance-module${i}-quiz-completed`) === 'true') {
                    modules[i].completed = true;
                    if (i < 3) unlockModule(i + 1);
                    const moduleCard = document.getElementById(`module${i}`) || (i === 1 ? document.querySelector('.module-card') : null);
                    const quizContainer = moduleCard ? moduleCard.querySelector('.quiz-container') : null;
                    if (quizContainer) quizContainer.classList.add('available');
                }
            }
            updateAllProgress();
        }

        function unlockModule(moduleNum) {
            const moduleCard = document.getElementById(`module${moduleNum}`);
            const moduleStatus = moduleCard ? moduleCard.querySelector('.module-status') : null;
            if (moduleCard) {
                moduleCard.classList.remove('locked');
                if (moduleStatus) { moduleStatus.textContent = 'Unlocked'; moduleStatus.classList.add('unlocked'); moduleStatus.classList.remove('locked'); }
            }
        }

        function setupSlideNavigation(moduleNum) {
            const module = modules[moduleNum];
            const prefix = module.prefix;
            function updateSlide() {
                const moduleContainer = document.getElementById(`module${moduleNum}-slides`);
                if (!moduleContainer) return;
                const slides = moduleContainer.querySelectorAll('.slide');
                slides.forEach(slide => slide.classList.remove('active'));
                const currentSlideEl = document.getElementById(`${prefix}slide${module.currentSlide}`);
                if (currentSlideEl) currentSlideEl.classList.add('active');
                const indicators = moduleContainer.querySelectorAll('.slide-indicator');
                indicators.forEach((indicator, index) => { indicator.classList.toggle('active', index + 1 === module.currentSlide); });
                const prevBtn = document.getElementById(`${prefix}prev-slide`);
                const nextBtn = document.getElementById(`${prefix}next-slide`);
                if (prevBtn) prevBtn.disabled = module.currentSlide === 1;
                if (nextBtn) nextBtn.disabled = module.currentSlide === module.totalSlides;
                const moduleCard = document.getElementById(`module${moduleNum}`) || document.querySelector('.module-card');
                const quizContainer = moduleCard ? moduleCard.querySelector('.quiz-container') : null;
                if (quizContainer && module.currentSlide === module.totalSlides) {
                    quizContainer.classList.add('available');
                    if (!quizContainer.querySelector('.quiz-available-notice')) {
                        const notice = document.createElement('div');
                        notice.className = 'quiz-available-notice';
                        notice.innerHTML = '<p style="color: #5ddc7e; font-weight: bold; margin-bottom: 1rem;">üìñ Great! You\'ve completed the learning material. Now test your knowledge below:</p>';
                        quizContainer.insertBefore(notice, quizContainer.firstChild);
                    }
                }
                updateModuleProgress(moduleNum);
            }
            const nextBtn = document.getElementById(`${prefix}next-slide`);
            const prevBtn = document.getElementById(`${prefix}prev-slide`);
            if (nextBtn) { const newBtn = nextBtn.cloneNode(true); newBtn.addEventListener('click', function() { if (module.currentSlide < module.totalSlides) { module.currentSlide++; updateSlide(); } }); nextBtn.parentNode.replaceChild(newBtn, nextBtn); }
            if (prevBtn) { const newBtn = prevBtn.cloneNode(true); newBtn.addEventListener('click', function() { if (module.currentSlide > 1) { module.currentSlide--; updateSlide(); } }); prevBtn.parentNode.replaceChild(newBtn, prevBtn); }
            const moduleContainer = document.getElementById(`module${moduleNum}-slides`);
            if (moduleContainer) {
                const indicators = moduleContainer.querySelectorAll('.slide-indicator');
                indicators.forEach(indicator => { const newInd = indicator.cloneNode(true); newInd.addEventListener('click', function() { module.currentSlide = parseInt(this.getAttribute('data-slide')); updateSlide(); }); indicator.parentNode.replaceChild(newInd, indicator); });
            }
            updateSlide();
        }

        function setupQuizFunctionality(moduleNum) {
            const module = modules[moduleNum];
            const prefix = module.prefix;
            const moduleCard = document.getElementById(`module${moduleNum}`) || document.querySelector('.module-card');
            if (!moduleCard) return;
            populateQuiz(moduleNum);
            const quizOptions = moduleCard.querySelectorAll('.quiz-option');
            quizOptions.forEach(option => {
                const newOption = option.cloneNode(true);
                newOption.addEventListener('click', function() {
                    this.parentElement.querySelectorAll('.quiz-option').forEach(sib => sib.classList.remove('selected'));
                    this.classList.add('selected');
                    const deselectBtn = this.closest('.quiz-question').querySelector('.deselect-btn');
                    if (deselectBtn) deselectBtn.style.display = 'inline-block';
                });
                option.parentNode.replaceChild(newOption, option);
            });
            const deselectBtns = moduleCard.querySelectorAll('.deselect-btn');
            deselectBtns.forEach(btn => {
                const newBtn = btn.cloneNode(true);
                newBtn.addEventListener('click', function() {
                    const question = this.closest('.quiz-question');
                    question.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));
                    const feedback = question.querySelector('.quiz-feedback');
                    feedback.style.display = 'none'; feedback.textContent = '';
                    this.style.display = 'none';
                });
                btn.parentNode.replaceChild(newBtn, btn);
            });
            const submitBtn = document.getElementById(`${prefix}submit-quiz`);
            if (submitBtn) {
                const newSubmitBtn = submitBtn.cloneNode(true);
                newSubmitBtn.addEventListener('click', function() {
                    let correct = 0;
                    const questions = moduleCard.querySelectorAll('.quiz-question');
                    questions.forEach(question => {
                        const selected = question.querySelector('.quiz-option.selected');
                        const feedback = question.querySelector('.quiz-feedback');
                        if (!selected) { feedback.textContent = 'Please select an answer.'; feedback.className = 'quiz-feedback feedback-incorrect'; feedback.style.display = 'block'; return; }
                        question.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('correct', 'incorrect'));
                        if (selected.getAttribute('data-correct') === 'true') { selected.classList.add('correct'); feedback.textContent = 'Correct!'; feedback.className = 'quiz-feedback feedback-correct'; correct++; }
                        else { selected.classList.add('incorrect'); question.querySelector('.quiz-option[data-correct="true"]').classList.add('correct'); feedback.textContent = 'Incorrect. The correct answer is highlighted.'; feedback.className = 'quiz-feedback feedback-incorrect'; }
                        feedback.style.display = 'block';
                    });
                    if (correct === questions.length) { localStorage.setItem(`compliance-module${moduleNum}-quiz-completed`, 'true'); modules[moduleNum].completed = true; alert(`Congratulations! You've completed Module ${moduleNum} with a perfect score!`); if (module.nextModule) unlockModule(module.nextModule); updateModuleProgress(moduleNum); }
                    else { alert(`You got ${correct} out of ${questions.length} questions correct. Review the incorrect answers and try again!`); }
                });
                submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
            }
            const resetBtn = document.getElementById(`${prefix}reset-quiz`);
            if (resetBtn) {
                const newResetBtn = resetBtn.cloneNode(true);
                newResetBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to reset the quiz? This will generate new questions and clear your answers.')) {
                        moduleCard.querySelectorAll('.quiz-question').forEach(question => {
                            question.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));
                            const feedback = question.querySelector('.quiz-feedback'); feedback.style.display = 'none'; feedback.textContent = '';
                            const deselectBtn = question.querySelector('.deselect-btn'); if (deselectBtn) deselectBtn.style.display = 'none';
                        });
                        populateQuiz(moduleNum);
                    }
                });
                resetBtn.parentNode.replaceChild(newResetBtn, resetBtn);
            }
        }

        function updateModuleProgress(moduleNum) {
            const module = modules[moduleNum];
            let progress = (module.currentSlide / module.totalSlides) * 50;
            if (localStorage.getItem(`compliance-module${moduleNum}-quiz-completed`) === 'true') progress += 50;
            progress = Math.min(Math.round(progress), 100);
            const progressText = document.getElementById(`module${moduleNum}-progress`);
            const progressBar = document.getElementById(`module${moduleNum}-progress-bar`);
            if (progressText) progressText.textContent = `${progress}%`;
            if (progressBar) progressBar.style.width = `${progress}%`;
            return progress;
        }

        function updateAllProgress() { for (let i = 1; i <= 3; i++) updateModuleProgress(i); }

        initializeModules();
        for (let i = 1; i <= 3; i++) { setupSlideNavigation(i); setupQuizFunctionality(i); }
        document.querySelectorAll('.module-card').forEach((card, index) => {
            const moduleNum = index + 1;
            if (moduleNum > 1 && localStorage.getItem(`compliance-module${moduleNum-1}-quiz-completed`) !== 'true') card.classList.add('locked');
        });
    });
</script>
{% endblock %}
