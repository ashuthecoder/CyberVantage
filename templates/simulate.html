{% extends "base.html" %}
{% block title %}Simulation - CyberVantage{% endblock %}

{% block extra_styles %}
<style>
.simulation-phase, .simulation-complete {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    padding: 2rem;
    border-radius: 16px;
    backdrop-filter: blur(var(--glass-blur));
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto;
}

.simulation-complete {
    text-align: center;
}

.email-container {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 1.5rem;
    margin: 2rem 0;
    overflow-wrap: break-word;
}

.email-header {
    border-bottom: 1px solid var(--glass-border);
    padding-bottom: 1rem;
    margin-bottom: 1rem;
    color: rgba(255, 255, 255, 0.7);
}

.email-header strong {
    color: var(--accent-color);
}

.email-body {
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.7;
    width: 100%;
}

/* Phase 2 emails are AI-generated and often include a fixed-width wrapper (e.g. max-width:600px).
   These overrides make the rendered email use the same full-width container as Phase 1. */
.phase2 .email-body table,
.phase2 .email-body tbody,
.phase2 .email-body tr,
.phase2 .email-body td {
    max-width: 100% !important;
}

.phase2 .email-body table {
    width: 100% !important;
}

.phase2 .email-body img {
    max-width: 100% !important;
    height: auto !important;
}

.phase2 .email-body [style*="max-width" i] {
    max-width: 100% !important;
    width: 100% !important;
}

.phase2 .email-body [width] {
    max-width: 100% !important;
}

.phase2 .email-body {
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    padding: 0;
}

.phase2-email-frame {
    width: 100%;
    border: 0;
    display: block;
    background: #fff;
    min-height: 520px;
}

.small-btn {
    padding: 0.45rem 1rem;
    font-size: 0.8rem;
    border-radius: 50px;
}

.bottom-actions {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
}

.progress {
    margin-top: 2rem;
}

.progress-bar {
    background: rgba(255, 255, 255, 0.08);
    height: 10px;
    border-radius: 5px;
    margin-top: 0.5rem;
    overflow: hidden;
}

.progress-fill {
    background: linear-gradient(90deg, var(--accent-color), var(--accent-secondary));
    height: 100%;
    border-radius: 5px;
}

.options {
    margin: 1rem 0;
}

.options label {
    margin-right: 2rem;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.85);
}

.options input[type="radio"] {
    width: auto;
    margin-right: 8px;
}

.btn {
    padding: 0.6rem 1.5rem;
    border-radius: 50px;
    text-decoration: none;
    cursor: pointer;
    display: inline-block;
    border: none;
    margin-top: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.primary {
    background: var(--accent-color);
    color: #000;
}

.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
}

.secondary {
    background: rgba(255, 255, 255, 0.08);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.15);
    margin-left: 1rem;
}

.secondary:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
}

.warning {
    background: rgba(255, 193, 7, 0.25);
    color: #ffd93d;
    border: 1px solid rgba(255, 193, 7, 0.4);
}

.warning:hover {
    background: rgba(255, 193, 7, 0.4);
}

.restart-btn {
    background: rgba(230, 126, 34, 0.3);
    color: #f39c12;
    border: 1px solid rgba(230, 126, 34, 0.5);
    padding: 0.6rem 1.5rem;
    border-radius: 50px;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
    transition: all 0.3s;
}

.restart-btn:hover {
    background: rgba(230, 126, 34, 0.5);
    transform: translateY(-2px);
}

textarea {
    min-height: 120px;
}

.explanation {
    margin-top: 1.5rem;
}

.top-actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1rem;
}

.muted {
    color: rgba(255, 255, 255, 0.5);
}

.question p {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
}

.next-steps {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
}

.next-steps-info {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--glass-border);
    padding: 1.5rem;
    border-radius: 12px;
    margin: 2rem 0;
    text-align: left;
}

.next-steps-info h3 {
    margin-top: 0;
    color: var(--accent-color);
}

.next-steps-info ul {
    text-align: left;
    color: rgba(255, 255, 255, 0.8);
}

.next-steps-info li {
    margin-bottom: 0.5rem;
}

.next-steps-info .pro-tip {
    background: rgba(0, 242, 255, 0.05);
    padding: 1rem;
    border-left: 4px solid var(--accent-color);
    margin-top: 1rem;
    border-radius: 0 8px 8px 0;
}
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <div class="top-actions">
        <a href="{{ url_for('simulation.restart_simulation') }}" class="restart-btn">Restart Simulation</a>
    </div>

    <h1 style="text-align: center;">Email Phishing Simulation</h1>

{# Phase 1: predefined emails 1..5 #}
{% if phase == 1 and 1 <= current_email <= 5 %}
    <div class="simulation-phase">
        <h2>Phase 1: Test Your Instincts</h2>
        <p>Look at the email below and determine if it's legitimate or a phishing attempt.</p>

        <div class="email-container">
            <div class="email-header">
                <p><strong>From:</strong> {{ email.sender }}</p>
                <p><strong>Subject:</strong> {{ email.subject }}</p>
                <p><strong>Date:</strong> {{ email.date }}</p>
            </div>
            <div class="email-body">
                {{ email.content|safe }}
            </div>
        </div>

        <form method="POST" action="{{ url_for('simulation.submit_simulation') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="email_id" value="{{ email.id }}">
            <input type="hidden" name="phase" value="1">

            <div class="question">
                <p>Is this a phishing/spam email?</p>
                <div class="options">
                    <label><input type="radio" name="is_spam" value="true" required> Yes</label>
                    <label><input type="radio" name="is_spam" value="false"> No</label>
                </div>
            </div>

            <button type="submit" class="btn primary">Submit Answer</button>
            <a href="{{ url_for('simulation.restart_simulation') }}" class="btn secondary">Restart</a>
            <a href="{{ url_for('simulation.skip_email') }}" class="btn warning">Skip Email</a>
        </form>

        <div class="progress">
            <p style="color: rgba(255,255,255,0.7);">Email {{ current_email }} of 5</p>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (current_email / 5) * 100 }}%"></div>
            </div>
        </div>

        <div class="bottom-actions">
            <a href="{{ url_for('simulation.skip_to_phase2') }}" class="btn secondary small-btn">Skip to Phase 2</a>
        </div>
    </div>

{# Phase 2: advanced analysis #}
{% elif phase == 2 %}
    {% set p2_completed = session.get('phase2_emails_completed', 0) %}
    {% set p2_index = p2_completed + 1 %}
    <div class="simulation-phase phase2">
        <h2>Phase 2: Advanced Analysis</h2>
        <p>Now let's test your reasoning skills. Analyze the email, determine if it's legitimate or phishing, and explain your reasoning.</p>

        {% if not email %}
            <div class="email-container" style="text-align: center;">
                <p class="muted">No email is available to display right now. Please try again or restart the simulation.</p>
                <div style="margin-top: 1rem;">
                    <a href="{{ url_for('simulation.simulate') }}" class="btn secondary">Reload</a>
                    <a href="{{ url_for('simulation.restart_simulation') }}" class="btn secondary">Restart</a>
                    <a href="{{ url_for('simulation.skip_email') }}" class="btn warning">Skip Email</a>
                </div>
            </div>
        {% else %}
            <h3 style="color: var(--accent-color);">Advanced Email #{{ p2_index }}</h3>

             <div class="email-container">
                 <div class="email-header">
                     <p><strong>From:</strong> {{ email.sender }}</p>
                     <p><strong>Subject:</strong> {{ email.subject }}</p>
                     <p><strong>Date:</strong> {{ email.date }}</p>
                 </div>
                 <div class="email-body">
                     <iframe
                         class="phase2-email-frame"
                         sandbox
                         referrerpolicy="no-referrer"
                         title="Email content preview"
                     ></iframe>
                     <script>
                         window.__PHASE2_EMAIL_HTML__ = {{ (email.content or '')|tojson }};
                     </script>
                 </div>
             </div>

            <form method="POST" action="{{ url_for('simulation.submit_simulation') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="email_id" value="{{ email.id }}">
                <input type="hidden" name="phase" value="2">

                <div class="question">
                    <p>Is this a phishing/spam email?</p>
                    <div class="options">
                        <label><input type="radio" name="is_spam" value="true" required> Yes</label>
                        <label><input type="radio" name="is_spam" value="false"> No</label>
                    </div>
                </div>

                <div class="explanation">
                    <p style="color: rgba(255,255,255,0.9);">Please explain your reasoning:</p>
                    <textarea name="explanation" rows="4" required
                        placeholder="What indicators informed your decision? Sender domain, links, urgency, grammar, mismatched URLs, etc."></textarea>
                </div>

                <button type="submit" class="btn primary">Submit Answer</button>
                <a href="{{ url_for('simulation.restart_simulation') }}" class="btn secondary">Restart</a>
                <a href="{{ url_for('simulation.skip_email') }}" class="btn warning">Skip Email</a>
            </form>

            <div class="progress">
                <p style="color: rgba(255,255,255,0.7);">Advanced Email {{ p2_index }} of 5</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ (p2_completed / 5) * 100 }}%"></div>
                </div>
                <p class="muted">Completed: {{ p2_completed }} / 5</p>
            </div>
        {% endif %}
    </div>

{% elif phase == 'complete' %}
    <div class="simulation-complete">
        <h2>&#127881; Simulation Complete!</h2>
        <p>Congratulations! You've successfully completed both phases of the phishing email simulation.</p>
        <p>Your responses have been recorded and will be analyzed to provide you with a detailed report.</p>
        
        <div class="next-steps-info">
            <h3>&#128218; What's Next?</h3>
            <ul>
                <li><strong>View Your Analysis:</strong> See detailed feedback on your performance and learn from your responses</li>
                <li><strong>Final Assignment:</strong> Put your skills to the test by crafting realistic phishing emails to understand attacker tactics</li>
                <li><strong>Advanced Learning:</strong> Explore threat intelligence tools and deepen your cybersecurity knowledge</li>
            </ul>
            <div class="pro-tip">
                <p style="margin: 0;"><strong>&#128161; Pro Tip:</strong> The final assignment will help you understand how attackers create convincing phishing emails, making you better at spotting them in the real world!</p>
            </div>
        </div>

        <div class="next-steps">
            <a href="{{ url_for('analysis.analysis') }}" class="btn primary">&#128202; View Your Analysis</a>
            <a href="{{ url_for('threat.get_phishing_assignment') }}" class="btn primary">&#127919; Start Final Assignment</a>
            <a href="{{ url_for('simulation.restart_simulation') }}" class="restart-btn">&#128260; Restart Simulation</a>
            <a href="{{ url_for('dashboard') }}" class="btn secondary">&#127968; Return to Dashboard</a>
        </div>
    </div>

{% else %}
    <div class="simulation-phase" style="text-align: center;">
        <p class="muted">No simulation content to display. Please try restarting the simulation.</p>
        <a href="{{ url_for('simulation.restart_simulation') }}" class="btn secondary">Restart</a>
    </div>
{% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (document.querySelector('.email-body') && document.querySelector('.email-body').innerHTML.trim() === '') {
            document.querySelector('.email-body').innerHTML = 
                '<div style="text-align: center; padding: 20px;">' +
                '<p>Error loading email content. Please try again.</p>' +
                '<button onclick="location.reload()" class="btn secondary">Reload Email</button>' +
                '</div>';
        }

        const frame = document.querySelector('.phase2-email-frame');
        if (frame && typeof window.__PHASE2_EMAIL_HTML__ === 'string') {
            const baseCss = `
                html, body { margin: 0; padding: 0; width: 100%; background: #ffffff; color: #111111; }
                img { max-width: 100% !important; height: auto !important; }
                table { width: 100% !important; max-width: 100% !important; }
                [width="600"], [style*="width:600px" i], [style*="width: 600px" i],
                [style*="max-width:600px" i], [style*="max-width: 600px" i] { width: 100% !important; max-width: 100% !important; }
            `;

            const injectStyle = (html) => {
                const styleTag = `<style>${baseCss}</style><base target="_blank">`;
                if (/<\/head\s*>/i.test(html)) {
                    return html.replace(/<\/head\s*>/i, `${styleTag}</head>`);
                }
                if (/<html[\s>]/i.test(html)) {
                    return html.replace(/<html([\s>])/i, `<html$1<head>${styleTag}</head>`);
                }
                return `<!doctype html><html><head><meta charset="utf-8">${styleTag}</head><body>${html}</body></html>`;
            };

            frame.srcdoc = injectStyle(window.__PHASE2_EMAIL_HTML__);
        }
    });
</script>
{% endblock %}
