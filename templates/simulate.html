{% extends "base.html" %}
{% block title %}Simulation - CyberVantage{% endblock %}

{% block extra_styles %}
.email-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    margin: 2rem 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.email-header {
    border-bottom: 1px solid #eee;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.progress {
    margin-top: 2rem;
}

.progress-bar {
    background: #eee;
    height: 10px;
    border-radius: 5px;
    margin-top: 0.5rem;
}

.progress-fill {
    background: #3498db;
    height: 100%;
    border-radius: 5px;
}

.options {
    margin: 1rem 0;
}

.options label {
    margin-right: 2rem;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
}

.options input[type="radio"] {
    width: auto;
    margin-right: 8px;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    text-decoration: none;
    cursor: pointer;
    display: inline-block;
    border: none;
    margin-top: 1rem;
}

.primary {
    background-color: #2a3f54;
    color: white;
}

.secondary {
    background-color: #7f8c8d;
    color: white;
    margin-left: 1rem;
}

.warning {
    background-color: #ff9800;
    color: white;
}

.restart-btn {
    background-color: #e67e22;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
}

.restart-btn:hover {
    background-color: #d35400;
}

textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-height: 120px;
}

.explanation {
    margin-top: 1.5rem;
}

.top-actions {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1rem;
}

.muted {
    color: #666;
}

.simulation-phase {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto;
}

.simulation-complete {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
    margin: 0 auto;
}

.email-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    margin: 2rem 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    max-width: 100%;
    box-sizing: border-box;
    overflow-wrap: break-word;
}

/* Ensure consistent container width */
.container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 1rem;
    box-sizing: border-box;
}

.next-steps {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
}

.next-steps-info h3 {
    margin-top: 0;
}

.next-steps-info ul {
    text-align: left;
}

.next-steps-info li {
    margin-bottom: 0.5rem;
}
{% endblock %}

{% block content %}
<div class="container">
    <div class="top-actions">
        <a href="{{ url_for('simulation.restart_simulation') }}" class="restart-btn">Restart Simulation</a>
    </div>

    <h1>Email Phishing Simulation</h1>

{# Phase 1: predefined emails 1..5 #}
{% if phase == 1 and 1 <= current_email <= 5 %}
    <div class="simulation-phase">
        <h2>Phase 1: Test Your Instincts</h2>
        <p>Look at the email below and determine if it's legitimate or a phishing attempt.</p>

        <div class="email-container">
            <div class="email-header">
                <p><strong>From:</strong> {{ email.sender }}</p>
                <p><strong>Subject:</strong> {{ email.subject }}</p>
                <p><strong>Date:</strong> {{ email.date }}</p>
            </div>
            <div class="email-body">
                {{ email.content|safe }}
            </div>
        </div>

        <form method="POST" action="{{ url_for('simulation.submit_simulation') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="email_id" value="{{ email.id }}">
            <input type="hidden" name="phase" value="1">

            <div class="question">
                <p>Is this a phishing/spam email?</p>
                <div class="options">
                    <label><input type="radio" name="is_spam" value="true" required> Yes</label>
                    <label><input type="radio" name="is_spam" value="false"> No</label>
                </div>
            </div>

            <button type="submit" class="btn primary">Submit Answer</button>
            <a href="{{ url_for('simulation.restart_simulation') }}" class="btn secondary">Restart</a>
            <a href="{{ url_for('simulation.skip_email') }}" class="btn warning">Skip Email</a>
        </form>

        <div class="progress">
            <p>Email {{ current_email }} of 5</p>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (current_email / 5) * 100 }}%"></div>
            </div>
        </div>
    </div>

{# Phase 2: advanced analysis #}
{% elif phase == 2 %}
    {% set p2_completed = session.get('phase2_emails_completed', 0) %}
    {% set p2_index = p2_completed + 1 %}
    <div class="simulation-phase">
        <h2>Phase 2: Advanced Analysis</h2>
        <p>Now let's test your reasoning skills. Analyze the email, determine if it's legitimate or phishing, and explain your reasoning.</p>

        {% if not email %}
            <div class="email-container" style="text-align: center;">
                <p class="muted">No email is available to display right now. Please try again or restart the simulation.</p>
                <div style="margin-top: 1rem;">
                    <a href="{{ url_for('simulation.simulate') }}" class="btn secondary">Reload</a>
                    <a href="{{ url_for('simulation.restart_simulation') }}" class="btn secondary">Restart</a>
                    <a href="{{ url_for('simulation.skip_email') }}" class="btn warning">Skip Email</a>
                </div>
            </div>
        {% else %}
            <h3>Advanced Email #{{ p2_index }}</h3>

            <div class="email-container">
                <div class="email-header">
                    <p><strong>From:</strong> {{ email.sender }}</p>
                    <p><strong>Subject:</strong> {{ email.subject }}</p>
                    <p><strong>Date:</strong> {{ email.date }}</p>
                </div>
                <div class="email-body">
                    {{ email.content|safe }}
                </div>
            </div>

            <form method="POST" action="{{ url_for('simulation.submit_simulation') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="email_id" value="{{ email.id }}">
                <input type="hidden" name="phase" value="2">

                <div class="question">
                    <p>Is this a phishing/spam email?</p>
                    <div class="options">
                        <label><input type="radio" name="is_spam" value="true" required> Yes</label>
                        <label><input type="radio" name="is_spam" value="false"> No</label>
                    </div>
                </div>

                <div class="explanation">
                    <p>Please explain your reasoning:</p>
                    <textarea name="explanation" rows="4" required
                        placeholder="What indicators informed your decision? Sender domain, links, urgency, grammar, mismatched URLs, etc."></textarea>
                </div>

                <button type="submit" class="btn primary">Submit Answer</button>
                <a href="{{ url_for('simulation.restart_simulation') }}" class="btn secondary">Restart</a>
                <a href="{{ url_for('simulation.skip_email') }}" class="btn warning">Skip Email</a>
            </form>

            <div class="progress">
                <p>Advanced Email {{ p2_index }} of 5</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ (p2_completed / 5) * 100 }}%"></div>
                </div>
                <p class="muted">Completed: {{ p2_completed }} / 5</p>
            </div>
        {% endif %}
    </div>

{% elif phase == 'complete' %}
    <div class="simulation-complete">
        <h2>🎉 Simulation Complete!</h2>
        <p>Congratulations! You've successfully completed both phases of the phishing email simulation.</p>
        <p>Your responses have been recorded and will be analyzed to provide you with a detailed report.</p>
        
        <div class="next-steps-info" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin: 2rem 0; text-align: left;">
            <h3 style="color: #2a3f54; margin-bottom: 1rem;">📚 What's Next?</h3>
            <ul style="color: #555; line-height: 1.6; margin: 0; padding-left: 1.5rem;">
                <li><strong>View Your Analysis:</strong> See detailed feedback on your performance and learn from your responses</li>
                <li><strong>Final Assignment:</strong> Put your skills to the test by crafting realistic phishing emails to understand attacker tactics</li>
                <li><strong>Advanced Learning:</strong> Explore threat intelligence tools and deepen your cybersecurity knowledge</li>
            </ul>
            <div style="background: #e8f4f8; padding: 1rem; border-left: 4px solid #3498db; margin-top: 1rem;">
                <p style="margin: 0; color: #2c3e50;"><strong>💡 Pro Tip:</strong> The final assignment will help you understand how attackers create convincing phishing emails, making you better at spotting them in the real world!</p>
            </div>
        </div>

        <div class="next-steps">
            <a href="{{ url_for('analysis.analysis') }}" class="btn primary">📊 View Your Analysis</a>
            <a href="{{ url_for('threat.phishing_assignment') }}" class="btn primary">🎯 Start Final Assignment</a>
            <a href="{{ url_for('simulation.restart_simulation') }}" class="restart-btn">🔄 Restart Simulation</a>
            <a href="{{ url_for('dashboard') }}" class="btn secondary">🏠 Return to Dashboard</a>
        </div>
    </div>

{% else %}
    <div class="simulation-phase" style="text-align: center;">
        <p class="muted">No simulation content to display. Please try restarting the simulation.</p>
        <a href="{{ url_for('simulation.restart_simulation') }}" class="btn secondary">Restart</a>
    </div>
{% endif %}
</div> <!-- Close container -->
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // If there's an error loading the email, add a reload button
        if (document.querySelector('.email-body') && document.querySelector('.email-body').innerHTML.trim() === '') {
            document.querySelector('.email-body').innerHTML = 
                '<div style="text-align: center; padding: 20px;">' +
                '<p>Error loading email content. Please try again.</p>' +
                '<button onclick="location.reload()" class="btn secondary">Reload Email</button>' +
                '</div>';
        }
    });
</script>
{% endblock %}